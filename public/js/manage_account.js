// Generated by CoffeeScript 1.3.1

define(['eg/eg_api', 'template', 'plugin'], function(eg, _) {
  return (function($) {
    var content, deferreds, tpl_item, tpl_manage_account;
    tpl_manage_account = function() {
      return $("#card_list", this).text(content);
    };
    content = '<ul class="card-list" data-role="listview"\n    data-split-icon="gear" data-split-theme="a"\n    data-inset="true">\n</ul>\n<a href="#add_card_popup" data-rel="popup" data-position-to="window"\n   data-transition="pop" class="ui-btn ui-corner-all">\n  Add a card\n</a>\n<a class="ui-btn back" data-icon="back" href="#" >Back</a>\n<div id="add_card_popup" class="popup ui-content">\n  <form class="add_card" action="/add_account" method="post"\n        accept-charset="utf-8">\n    <label for="card_id">Card ID number:</label>\n    <input type="text" name="card_id" />\n    <label for="card_name">Card Name:</label>\n    <input type="text" name="card_name" />\n    <label for="card_password">Password:</label>\n    <input type="password" name="card_password" />\n    <button type="submit" name="submit">Add card</button>\n    <a href="\n  </form>\n</div>';
    tpl_item = _.template('<li class="ui-field-contain" id="<%= card_oid %>">\n  <a href="#" class="card_index" title="Select this card."\n     data-card-index="<%= card_index %>">\n    <%= card_name %>\n  </a>\n  <a href="#popup-<%= card_index %>" data-rel="popup"\n     data-transition="pop">\n      Edit this card\n  </a>\n</li>\n<div data-role="popup" class="popup ui-content ui-corner-all"\n     id="popup-<%= card_index %>">\n  <form class="edit_card" method="post"\n        action="/edit_account">\n    <input type="hidden" name="card_oid" value="<%= card_oid %>" />\n    <label for="card_id">Card ID number:</label>\n    <input name="card_id" type="text" value="<%= card_id %>" />\n    <label for="card_name">Card Name:</label>\n    <input name="card_name" type="text" value="<%= card_name %>"/>\n    <label for="card_password">Password:</label>\n    <input name="card_password" type="password" />\n    <a data-rel="back" data-icon="back" class="ui-btn">Discard changes</a>\n    <button name="submit" class="ui-btn">Save changes</button>\n    <button name="delete_card" class="ui-btn">Delete this card</button>\n  </form>\n</div>');
    deferreds = [];
    return $.fn.manage_account = function() {
      var $item, $list, $manage_account, card, i, _i, _len, _ref;
      if (this.plugin()) {
        return this;
      }
      $manage_account = this.plugin('manage_account');
      if ($(".card-list").length > 0) {
        console.log("card-list exists");
      } else {
        this.html(content).trigger('create');
        this.find('.content').html(content).trigger('refresh');
        tpl_manage_account();
      }
      $list = $('.card-list', this);
      if (window.accounts != null) {
        _ref = window.accounts;
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          card = _ref[i];
          $list.append($item = $(tpl_item({
            card_index: i,
            card_name: card.name,
            card_id: card.id,
            card_password: card.password,
            card_oid: card._id
          })));
        }
      }
      $('.card-list').listview("refresh");
      $('.popup').popup();
      this.on('click', 'a.card_index', function() {
        var data;
        data = $(this).data();
        card = window.accounts[data.cardIndex];
        eg.openils('auth.session.create', {
          username: card.id,
          password: card.password,
          type: 'opac',
          org: 1
        }, function(resp) {
          while (deferreds.length > 0) {
            deferreds.pop().call();
          }
          $().publish('session.login', [card.name]);
          $('#manage_account').hide();
          $('body').pagecontainer('change', '#main', {
            'transition': 'slide'
          });
          $('#main').show();
          $('#manage_account').hide();
        });
        return false;
      });
      this.on('click', 'a.back', function() {
        $('#manage_account').hide();
        $('body').pagecontainer('change', '#main', {
          'transition': 'slide'
        });
        return false;
      });
      $('body').on('submit', 'form.edit_card', function() {
        $.post('/edit_account', {
          oid: $("input[name=card_oid]", this).val(),
          id: $("input[name=card_id]", this).val(),
          name: $("input[name=card_name]", this).val(),
          password: $("input[name=card_password]", this).val()
        }, function(data) {
          $('body').pagecontainer('change', '#manage_account');
          if (data.message != null) {
            return $().publish('notice', [data.message]);
          }
        });
        return false;
      });
      $('body').on('click', 'button[name="delete_card"]', function() {
        var oid;
        oid = $('input[name="card_oid"]', $(this).parent()).val();
        $.get('/remove_account/' + oid).success(function(response) {
          $('#' + oid).remove();
          return $('.popup').popup('close');
        }).done(function(response) {
          if (response.message != null) {
            return $().publish('notice', [response.message]);
          }
        });
        return false;
      });
      $('body').on('submit', 'form.add_card', function() {
        var id, name, password;
        id = $('input[name="card_id"]', this).val();
        name = $('input[name="card_name"]', this).val();
        password = $('input[name="card_password"]', this).val();
        eg.openils('auth.session.create', {
          username: id,
          password: password,
          type: 'opac',
          org: 1
        }, function(resp) {
          return $.post('/add_account', {
            id: id,
            name: name,
            password: password
          }, function(data) {
            $().publish('session.login', [name]);
            window.accounts.push({
              'id': id,
              'password': password,
              'name': name
            });
            $list = $('.card-list');
            $list.append($item = $(tpl_item({
              card_index: window.accounts.length - 1,
              card_name: name,
              card_id: id,
              card_password: password,
              card_oid: data.account._id
            })));
            $('.card-list').listview("refresh");
            $('.popup').popup();
            return $('.popup').popup('close');
          });
        });
        return false;
      });
      this.subscribe('session.login', function() {
        $('.manage_account').manage_account();
        return false;
      });
      return this.subscribe('session.logout', function() {
        $('.manage_account').empty();
        return false;
      });
    };
  })(jQuery);
});
