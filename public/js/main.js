// Generated by CoffeeScript 1.3.1

require.config({
  waitSeconds: 60,
  paths: {
    json2: '//ajax.cdnjs.com/ajax/libs/json2/20110223/json2',
    jsd: 'lib/jsdeferred',
    md5: 'lib/md5',
    jqm_sd: 'lib/jquery.mobile.simpledialog2',
    fmall: 'dojo/fieldmapper/fmall',
    fmd: 'eg/fm_datatypes'
  }
});

require(['base', 'messages2', 'load_spinner', 'login_bar', 'account_login', 'manage_account', 'eg/eg_api'], function(eg) {
  return (function($) {
    return $(function() {
      $('body').load_spinner();
      $('#messages').messages();
      $('#login_bar').login_bar();
      $('#account_login').account_login();
      if (window.active_id != null) {
        require(['eg/eg_api'], function(eg) {
          eg.openils('auth.session.create', {
            username: window.active_id,
            password: window.active_password,
            type: 'opac',
            org: 1
          }, function(resp) {
            return $().publish('session.login', [window.active_name]);
          });
        });
      }
      $('#manage_account').subscribe('session.login', function() {
        var _this = this;
        require(['manage_account'], function() {
          return $('#card_list').manage_account();
        });
        return false;
      });
      $('body').on('click', '.manage_account_link', function() {
        var _this = this;
        console.log("clicked on manage_account");
        $('#manage_account').show();
        $('body').pagecontainer('change', '#manage_account', {
          transition: 'slide'
        });
        require(['manage_account'], function() {
          return $('#card_list').manage_account();
        });
        return false;
      });
      $('.account_summary').hide();
      $('#account_summary').subscribe('session.login', function() {
        var _this = this;
        $('.account_summary', this).show();
        require(['account/summary'], function() {
          return _this.acct_summary();
        });
        return false;
      });
      $('#opac_search').one('click', function() {
        var _this = this;
        require(['opac/search'], function() {
          return $(_this).opac_search();
        });
      });
      $('.account_summary .ui-collapsible-heading').on('click', function() {
        $('#opac_search').trigger('collapse');
      });
      $('#opac_search').on('click', function() {
        $('.account_summary').each(function() {
          return $(this).trigger('collapse');
        });
      });
      $.fn.collapsed = function() {
        return this.closest('.ui-collapsible').is('.ui-collapsible-collapsed');
      };
      $('body').on('pageshow', function(e) {
        var t;
        t = e.target;
        switch (t.id) {
          case 'account_login':
            $('form input:eq(0)', t).focus();
        }
      });
      $('div[data-role="page"]').css({
        visibility: 'visible'
      });
      $('#startup').empty();
    });
  })(jQuery);
});
