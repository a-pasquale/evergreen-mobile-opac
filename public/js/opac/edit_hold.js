// Generated by CoffeeScript 1.3.1

define(['eg/eg_api', 'template', 'plugin', 'opac/cover_art', 'opac/title_details', 'opac/holding_details', 'opac/hold_details'], function(eg, _) {
  return (function($) {
    var content;
    content = '<div class="title_details"></div>\n<div class="holding_details"></div>\n<div class="hold_details"></div>';
    return $.fn.edit_hold = function() {
      var $plugin, count, title_bar, title_id, total,
        _this = this;
      if (this.plugin()) {
        return this;
      }
      title_bar = _.template('<h3>\n	Title <span class="count"><%= count %></span> of <span class="total"><%= total %></span>\n</h3>\n<div data-role="controlgroup" data-type="horizontal" class="ui-btn-right">\n	<div data-role="button" data-icon="arrow-u" data-mini="false" class="prev"></div>\n	<div data-role="button" data-icon="arrow-d" data-mini="false" class="next"></div>\n</div>');
      count = total = 0;
      title_id = 0;
      $('.title_bar', this).html(title_bar({
        count: 0,
        total: 0
      })).on('click', 'div', function(e) {
        var $target;
        $target = $(e.currentTarget);
        count = Number($('.count', _this).text());
        if ($target.hasClass('prev')) {
          if (count !== 1) {
            count -= 1;
            $('.count', _this).text(count);
          }
          _this.publish('opac.title', [title_id, -1]);
        } else if ($target.hasClass('next')) {
          if (count !== total) {
            count += 1;
            $('.count', _this).text(count);
          }
          _this.publish('opac.title', [title_id, +1]);
        }
        return false;
      });
      return $plugin = this.plugin('edit_hold').find('.content').html(content).trigger('create').end().subscribe('opac.title_details', function(titles_total, titles_count, titleid, $img) {
        title_id = titleid;
        if (_this !== $.mobile.activePage) {
          $.mobile.changePage(_this.page());
        }
        $('.total', _this).text(total = titles_total);
        $('.count', _this).text(count = titles_count);
        return $('.title_details', _this).title_details(titleid, $img).cover_art().trigger('create');
      }).subscribe('opac.title_holdings', function(titleid, search_ou, search_depth) {
        return eg.openils('search.config.copy_status.retrieve.all', function(status_names) {
          return $('.holding_details', _this).holding_details(titleid, search_ou, search_depth, status_names).trigger('create');
        });
      }).subscribe('opac.title_hold', function(titleid) {
        return $('.hold_details', _this).hold_details({
          target: titleid,
          titleid: titleid
        });
      });
    };
  })(jQuery);
});
